<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
		<meta name="format-detection" content="telephone=no">
		<meta content="email=no" name="format-detection" />
		<script type="text/javascript" src="js/app.js"></script>
		<script type="text/javascript" src="js/global.js"></script>
		<script type="text/javascript" src="js/mui.min.js"></script>
		<script type="text/javascript" src="js/mui.lazyload.js"></script>
		<script type="text/javascript" src="js/mui.lazyload.img.js"></script>
		<link rel="stylesheet" href="css/mui.min.css" />
		<link rel="stylesheet" href="css/app.css" />
		<link rel="stylesheet" href="css/index.css" />
		<title>微软装</title>
	</head>

	<body onresize="javascript:adaptive();">
		<div id="load">
			<div class="loading"></div>
			<div class="loading-text" style="text-align: center;">加载中，请稍候...</div>
		</div>
		<header class="mui-bar mui-bar-nav">
			<span id="cart" class="iconfont icon-gouwuche icon-left-nav mui-icon mui-pull-right"></span>
			<span id="intelligent" class="mui-icon mui-icon-pengyouquan icon-left-nav mui-icon mui-pull-right">&nbsp;&nbsp;&nbsp;</span>
			<span class="mui-icon mui-icon-home icon-left-nav mui-icon mui-pull-right" style="color: #ccc;">&nbsp;&nbsp;&nbsp;</span>
		</header>
		<div class="mui-content">
			<div id="nodata"><span>暂无数据</span></div>
			<div id="list" class="pictures">
			</div>
		</div>

	</body>
	<script>
		mui.ready(function() {
			startload();
			("IntelligentCollocation" in GetRequest()) ? ((JSON.parse(localStorage.schemes).length) ? (lazyload(), adaptive(), stopload(), addtapevent()) : (lazyload(), stopload())) : getschemes();
		});

		function getschemes() {
			mui.ajax(apiurl + 'schemes?fields=id,name,amount,cover_t_img-url&filter=custom_edited:0', {
				data: {},
				dataType: 'json',
				type: 'get',
				timeout: 6000,
				success: function(data) {
					if (data.success == true) {
						localStorage.schemes = JSON.stringify(data.data.items);
						(lazyload(), adaptive(), stopload(), addtapevent());
					} else {
						mui.alert(data.message);
						stopload();
					}
				}
			});
		}

		function addtapevent() {
			mui('#list').on('tap', '.indexpic img', function() {
				id = this.getAttribute('data-id');
				mui.openWindow({
					url: "schemes.html?id=" + id,
					id: "schemes",
					show: {
						aniShow: 'zoom-fade-out',
						duration: 300
					}
				});
				return;
			});
		}

		function lazyload() {
			tempindeximg = JSON.parse(localStorage.schemes);
			schemelist = new Array;
			for (i = 0; i < tempindeximg.length; i++) {
				schemelist[i] = '{"title":"' + tempindeximg[i].name + '","price":' + tempindeximg[i]['amount'] / 100 + ',"preview":"' + tempindeximg[i]['cover_t_img-url'] + '","id":"' + tempindeximg[i].id + '"}'
				schemelist[i] = JSON.parse(schemelist[i]);
			}
			document.getElementById("nodata").style.display = "none";
			if (schemelist.length == 0) {
				document.getElementById("nodata").style.display = "block";
				return false;
			}
			var createFragment = function(count) {
				console.log(JSON.stringify(schemelist))
				var fragment = document.createDocumentFragment();
				var span;
				div = document.createElement('div');
				div.className = "indexpic";
				div.innerHTML = '<img data-lazyload="' + serverurl + schemelist[0].preview + '" data-id="'+schemelist[0].id+'"><p class="title">' + schemelist[0].title + '<span class="scpr"><i class="hr">/</i>￥' + schemelist[0].price + '</span></p>';
				fragment.appendChild(div);
				for (var i = 1; i < count; i++) {
					div = document.createElement('div');
					div.className = "indexpic margin180";
					div.innerHTML = '<img data-lazyload="' + serverurl + schemelist[i].preview + '" data-id="' + schemelist[i].id + '"><p class="title">' + schemelist[i].title + '<span class="scpr"><i class="hr">/</i>￥' + schemelist[i].price + '</span></p>';
					fragment.appendChild(div);
				}
				return fragment;
			};
			(function($) {
				var list = document.getElementById("list");
				list.appendChild(createFragment(schemelist.length));
				$(document).imageLazyload({
					placeholder: 'images/default-1.png'
				});
				adaptive();
			})(mui);
		}

		function adaptive() {
			cases = document.getElementsByClassName("indexpic");
			title = document.getElementsByClassName("title");
			casesHeight = 0.611 * cases[0].scrollWidth;
			for (i = 0; i < cases.length; i++) {
				cases[i].style.height = casesHeight + 'px';
			}
		}
		document.getElementById('cart').addEventListener('tap', function() {
			mui.openWindow({
				url: "cart.html",
				id: "cart",
				show: {
					aniShow: 'zoom-fade-out',
					duration: 300
				}
			});
			return;
		});
		document.getElementById('intelligent').addEventListener('tap', function() {
			mui.openWindow({
				url: "match.html?layer",
				id: "match",
				show: {
					aniShow: 'zoom-fade-out',
					duration: 300
				}
			});
			return;
		});

		function enterschemes(e) {
			location.href = "schemes.html?id=" + e;
			return;
		}
	</script>

</html>