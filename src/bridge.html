<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
		<meta name="format-detection" content="telephone=no">
		<meta content="email=no" name="format-detection" />
		<script type="text/javascript" src="js/app.js"></script>
		<script type="text/javascript" src="js/global.js"></script>
		<script type="text/javascript" src="js/mui.min.js"></script>
		<script type="text/javascript" src="js/pingpp.js"></script>
		<link rel="stylesheet" href="css/mui.min.css" />
		<link rel="stylesheet" href="css/app.css" />
		<title>微软装</title>
	</head>

	<body>
		<div id="load">
			<div class="loading"></div>
			<div class="loading-text"><img src="images/load.gif" width="25px">加载中，请稍候...</div>
		</div>
	</body>
	<script>
		startload()
		var openid;
		var code = GetRequest()["code"];
		mui.ajax(apiurl + 'users/get-openid?access-token=' + strAccessToken, {
			data: {
				code: code
			},
			dataType: 'json',
			type: 'get',
			timeout: 6000,
			success: function(data) {
				openid = data;
				mui.ajax(apiurl + 'payments?access-token=' + strAccessToken, {
					data: {
						order_id: localStorage.temppayorderid,
						channel: "wx_pub"
					},
					dataType: 'json',
					type: 'post',
					timeout: 6000,
					success: function(data) {
						if (data.status == 201) {
							mui.ajax(apiurl + 'payments/pay?id=' + data.data.id + '&open_id=' + openid + '&access-token=' + strAccessToken, {
								dataType: 'json',
								type: 'get',
								timeout: 6000,
								success: function(data) {
									var charge = data.data.charge;
									pingpp.createPayment(charge, function(result, err) {
										if (result == "success") {
											mui.openWindow({
												url: "judge-order.html",
												id: "judge-order"
											});
										} else {
											alert("付款失败，请重试");
											mui.openWindow({
												url: "myorder.html?type=2",
												id: "myorder"
											});
										}
									});
								},
								error: function(xhr, type, errorThrown, message) {
									alert("网络连接失败，请稍候再试");
									mui.openWindow({
										url: "myorder.html?type=2",
										id: "myorder"
									});
									return false;
									stopload();
								}
							});
						}
					},
					error: function(xhr, type, errorThrown, message) {
						alert("网络连接失败，请稍候再试");
						mui.openWindow({
							url: "myorder.html?type=2",
							id: "myorder"
						});
						stopload();
					}
				});
			},
			error: function(xhr, type, errorThrown, message) {
				alert("网络连接失败，请稍候再试");
				mui.openWindow({
					url: "myorder.html?type=2",
					id: "myorder"
				});
				return false;
				stopload();
			}
		});
	</script>

</html>