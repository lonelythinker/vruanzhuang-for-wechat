<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
		<meta name="format-detection" content="telephone=no">
		<meta content="email=no" name="format-detection" />
		<script type="text/javascript" src="js/app.js"></script>
		<script type="text/javascript" src="js/global.js"></script>
		<script type="text/javascript" src="js/mui.min.js"></script>
		<script type="text/javascript" src="js/pingpp.js"></script>
		<link rel="stylesheet" href="css/mui.min.css" />
		<link rel="stylesheet" href="css/app.css" />
		<title>微软装</title>
	</head>

	<body>
		<div id="load">
			<div class="loading"></div>
			<div class="loading-text"><img src="images/load.gif" width="25px">加载中，请稍候...</div>
		</div>
	</body>
	<script>
		startload()
		var openid;
		var code = GetRequest()["code"];
		mui.ajax(apiurl + 'users/get-openid?access-token=' + JSON.parse(localStorage.userinfo).access_token, {
			data: {
				code: code
			},
			dataType: 'json',
			type: 'get',
			timeout: 6000,
			success: function(data) {
				openid = data;
				mui.ajax(apiurl + 'payments?access-token=' + JSON.parse(localStorage.userinfo).access_token, {
					data: {
						order_id: localStorage.temppayorderid,
						channel:"wx_pub" 
					},
					dataType: 'json',
					type: 'post',
					timeout: 6000,
					success: function(data) {
						if (data.status == 201) {
							mui.ajax(apiurl + 'payments/pay?id=' + data.data.id + '&open_id=' + openid + '&access-token=' + JSON.parse(localStorage.userinfo).access_token, {
								dataType: 'json',
								type: 'get',
								timeout: 6000,
								success: function(data) {
									charge = data.data.charge;
									pingpp.createPayment(charge, function(result, err) {
										if (result == "success") {
											location.href = "judge-order.html"
										} else {
											console.log(result + " " + err.msg + " " + err.extra);
											mui.alert("付款失败，请重试", "微软装");
										}
									});
								},
								error: function(xhr, type, errorThrown, message) {
									alert(xhr.status);
									alert(xhr.readyState);
									alert(errorThrown);
									mui.alert("网络连接失败，请稍候再试");
									return false;
									stopload();
								}
							});
						}
					},
					error: function(xhr, type, errorThrown, message) {
						mui.alert("网络连接失败，请稍候再试");
						stopload();
					}
				});
			},
			error: function(xhr, type, errorThrown, message) {
				alert("网络连接失败，请稍候再试");
				location.href = 'myorder.html'
				return false;
				stopload();
			}
		});
		//		
		//		
		//		
		//		
		//		
		////		mui.ajax(apiurl + 'jspackage?access-token=' + JSON.parse(localStorage.userinfo).access_token, {
		////			data: {
		////				this_url: encodeURIComponent(location.href.split('#')[0])
		////			},
		////			dataType: 'json',
		////			type: 'get',
		////			timeout: 6000,
		////			success: function(data) {
		////				configjson = data.data;
		////				configjson.debug = false;
		////				configjson.jsApiList = ['chooseWXPay'];
		////				console.log(JSON.stringify(configjson))
		////				wx.config(
		////					configjson
		////				);
		////				wx.error(function(res) {
		////					wx.config(
		////						configjson
		////					);
		////				});
		////				wx.ready(function() {
		////					onBridgeReady();
		////				});
		////			},
		////			error: function(xhr, type, errorThrown, message) {
		////				alert("网络连接失败，请稍候再试");
		////				location.href = 'myorder.html'
		////				stopload();
		////			}
		////		});
		//
		//		function onBridgeReady() {
		//			mui.ajax(apiurl + 'payments/pay/' + payid + '?access-token=' + JSON.parse(localStorage.userinfo).access_token, {
		//				data: {
		//					code: code
		//				},
		//				dataType: 'json',
		//				type: 'get',
		//				timeout: 6000,
		//				success: function(data) {
		//					console.log(JSON.stringify(data))
		//					onwxpay();
		//					function onwxpay(){
		//					WeixinJSBridge.invoke(
		//						'getBrandWCPayRequest', data.data,
		//						function(res) {
		//							if (res.err_msg == "get_brand_wcpay_request:ok") {
		//								location.href = "judge-order.html"
		////								mui.ajax(appurl + '/orders/' + localStorage.temppayorderid + '?access-token=' + JSON.parse(localStorage.userinfo).access_token, {
		////									data: {
		////										'status': '3',
		////									},
		////									dataType: 'json',
		////									type: 'put',
		////									timeout: 6000,
		////									success: function(data) {
		////										if (data.success == true) {
		////											location.href = 'myorder.html?type=3'
		////										}
		////									},
		////									error: function(xhr, type, errorThrown, message) {
		////										alert("网络连接失败，请稍候再试!");
		////										location.href = 'myorder.html?type=2'
		////										stopload();
		////									}
		////								});
		//							} else {
		//								stopload();
		//								var btnArray = ['确认', '取消'];
		//								mui.confirm('支付失败,是否重试？', '微软装', btnArray, function(e) {
		//									e.index == 0?onwxpay():location.href = 'myorder.html?type=2';
		//									}
		//								});
		//								
		//							}
		//						}
		//					);}
		//				},
		//				error: function(xhr, type, errorThrown, message) {
		//					alert("网络连接失败，请稍候再试");
		//					location.href = 'myorder.html?type=2'
		//					stopload();
		//				}
		//			});
		//		}
	</script>

</html>